"use strict";(this.webpackChunk_msteams_react_web_client=this.webpackChunk_msteams_react_web_client||[]).push([[823172],{823172:(e,t,i)=>{var r;i.d(t,{f:()=>T}),function(e){e.p720="720p",e.p1080="1080p",e.p2k="2k",e.p4k="4k",e.unkown="unkown"}(r||(r={}));const s=2073600,a=3686400,o=8294400;async function n(e){const t={Perf_Screen:void 0};let i;const n=e.screen.availWidth*e.screen?.availHeight;return i=n<s?r.p720:n>=s&&n<a?r.p1080:n>=a&&n<o?r.p2k:n>=o?r.p4k:r.unkown,t.Perf_Screen={width:e.screen?.availWidth,height:e.screen?.availHeight,resolution:i,dpr:e.devicePixelRatio},Promise.resolve(t)}var c;!function(e){e.Initializing="Initializing",e.Unrecoverable="Unrecoverable",e.LongInactive="LongInactive",e.Inactive="Inactive",e.Active="Active",e.VeryActive="VeryActive"}(c||(c={}));var l=i(472658),p=i(401368),h=i(183111),m=i(850305),d=i(880386);async function u(e,t,i){const r=await(e?.loadModule("heartbeat")),s=await(e?.loadModule("osutils")),[a,o]=await Promise.all([(async()=>{try{return await(((i?r?.getPerfMetricsAsync:void 0)??r?.getPerfMetrics)?.())}catch{t.errorToTelemetry?.("get-webview2-metrics, getMetrics: Failed to get memory metrics.","fundamentals_performance_get_webview2_metrics")}})(),(async()=>{try{return await(s?.getSystemMemoryInfo?.())}catch{t.errorToTelemetry?.("get-webview2-metrics, getMetrics: Failed to get os metrics.","fundamentals_performance_get_webview2_metrics")}})()]),n={system:{},workers:[],processes:[],windows:[]};if(o)try{n.system={totalPhysicalMemoryKB:(0,d.vr)(Number(o.totalPhysicalMemoryBytes)),availablePhysicalMemoryKB:(0,d.vr)(Number(o.availablePhysicalMemoryBytes)),totalSwapMemoryKB:(0,d.vr)(Number(o.totalSwapMemoryBytes)),availableSwapMemoryKB:(0,d.vr)(Number(o.availableSwapMemoryBytes)),memoryLoad:Number(o.memoryLoad)}}catch{t.errorToTelemetry?.("get-webview2-metrics, getMetrics: Failed to process os metrics.","fundamentals_performance_get_webview2_metrics")}if(a)try{let e;if("total"in a&&a.total&&(n.total={clientState:a.total.clientState,processCount:a.total.processCount,commitSizeKB:(0,d.vr)(a.total.pageFileUsageBytes),workingSetSizeKB:(0,d.vr)(a.total.workingSetSizeBytes),privateWorkingSetSizeKB:(0,d.vr)(a.total.privateWorkingSetSizeBytes)}),"length"in a)e=a;else{e=a.processes,n.windows=a.windows;for(const e of a.workers)n.workers.push({targetSessionId:e.targetSessionId,type:e.type,subType:e.subType,url:e.url,totalSizeKB:(0,d.vr)(e.totalSizeBytes),usedSizeKB:(0,d.vr)(e.usedSizeBytes)})}for(const t of e)n.processes.push({processId:t.processId,type:t.type,utilitySubType:t.utilitySubType,cpuCycleTime:t.cpuCycleTime,workingSetSizeKB:(0,d.vr)(t.workingSetSizeBytes),privateWorkingSetSizeKB:(0,d.vr)(0===t.privateWorkingSetSizeBytes?void 0:t.privateWorkingSetSizeBytes),commitSizeKB:(0,d.vr)(t.pageFileUsageBytes),cloudActivityState:t.cloudActivityState,isFromMyCloud:t.isFromMyCloud,isMainRenderer:t.isMainRenderer??!1})}catch{t.errorToTelemetry?.("get-webview2-metrics, getMetrics: Failed to process memory metrics.","fundamentals_performance_get_webview2_metrics")}return n}var g=i(480354);class S{constructor(e,t,i){this.hostCommunicationService=t,this.uuidToAppIdMap={},this.cmsObjects=[],this.trackAppCountOnly=i,this.logger=e.newLogger("PlatformAppsManagementService","core-services-telemetry")}updateAppCountTrackingFlag(e){e!==this.trackAppCountOnly&&(this.trackAppCountOnly=e)}async getTelemetry(){return this.getPlatformAppsStats()}async getAppsPerfMetrics(){return this.getPlatformAppsStats(!0)}addCacheManagementService(e){return this.cmsObjects.find((t=>t===e))?(this.logger.errorToTelemetry?.("addCacheManagementService: cms exists in appManagementService","platform_app_caching_cms_exists_in_app_management_service",void 0,!0),!1):(this.cmsObjects.push(e),!0)}removeCacheManagementService(e){return this.cmsObjects.splice(this.cmsObjects.indexOf(e),1),!0}addApp(e,t,i,r){return this.uuidToAppIdMap.hasOwnProperty(e)?(this.logger.errorToTelemetry?.("addApp: App exists in appManagementService","platform_app_exists_in_app_management_service",{"App.Id":t},!0),!1):(this.uuidToAppIdMap[e]={appId:t,managedByCache:i,isPrecachedApp:r},!0)}removeApp(e){return this.uuidToAppIdMap[e]?(delete this.uuidToAppIdMap[e],!0):(this.logger.errorToTelemetry?.("removeApp: App is not in uuid map","platform_app_missing_in_uuid_map",void 0,!0),!1)}removeLeastRecentlyUsedApp(e){if(this.isInCacheStabilizationPeriod())return void this.logger.log("removeLeastRecentlyUsedApp skipped due to stabilization period");let t;for(const e of this.cmsObjects){const i=e.getLeastRecentlyUsedApp();i&&(i.uuid&&i.timeInCache&&(void 0===t||i.timeInCache<t.timeInCache)&&(t={frameUuid:i.uuid,cmsObject:e,timeInCache:i.timeInCache}))}if(t?.frameUuid){const i=this.uuidToAppIdMap[t.frameUuid];i?.appId&&t.cmsObject.removeByAms(i?.appId,e)}}isInCacheStabilizationPeriod(){return this.cmsObjects.some((e=>e.isInCacheStabilizationPeriod()))}findProcessInfo(e,t){if(!t)return;const i=e.processes.find((e=>e.processId===t));return i?{workingSetSize:i.workingSetSizeKB,commitSize:i.commitSizeKB,cpuCycleTime:i.cpuCycleTime}:void 0}computeSizeOfFrames(e,t,i){const{memoryMetrics:r,processVisitedMap:s,appsVisited:a,isActiveApp:o,appsStats:n,perAppFrameData:c,frames:l,treeLevel:p}=e;for(const h of l){h.platformFrameUuid&&(o?n.activeAppsCount+=1:n.cachedAppsCount+=1);const l=this.findProcessInfo(r,h.processId);if(!l)return;const m=l.workingSetSize||0,d=l.commitSize||0;if(h.processId)if(s[h.processId]){const e=s[h.processId];e.currentFrameUuid!==i&&(e.currentFrameUuid=i,c.totalFrameWorkingSetSizeKB+=m,c.totalFrameCommitSizeKB+=d,c.maxCpuCycleTime=Math.max(c.maxCpuCycleTime,l.cpuCycleTime)),e.appIds.find((e=>e===t))||(e.appIds.push(t),a[t]&&this.addPerAppMetricsInfo(a[t],d,m))}else s[h.processId]={frame:h,currentFrameUuid:i,appIds:[t]},this.addAppStatsInfo(o,m,d,n),a[t]&&this.addPerAppMetricsInfo(a[t],d,m),c.totalFrameWorkingSetSizeKB+=m,c.totalFrameCommitSizeKB+=d,c.maxCpuCycleTime=Math.max(c.maxCpuCycleTime,l.cpuCycleTime);c.frameInfo.push({processId:h.processId,workingSetSizeKB:l.workingSetSize,cpuCycleTime:l.cpuCycleTime,treeLevel:p}),this.computeSizeOfFrames({...e,frames:h.frames,treeLevel:p+1},t,i)}}isActiveApp(e){let t=!1;for(const i of this.cmsObjects){const r=i.isAppCached(e);if(void 0!==r&&(t=!r,t))break}return t}async getPlatformAppsStats(e){const t={activeWorkingSetSizeKB:0,cachedWorkingSetSizeKB:0,activeCommitSizeKB:0,cachedCommitSizeKB:0,activeAppsCount:0,cachedAppsCount:0,appsPlatformFrameStats:[],appsPlatformStats:[]};if(!this.hostCommunicationService)return;const i=await u(this.hostCommunicationService,this.logger,!0),r={},s={},a={windows:i.windows,appsVisited:s,processVisitedMap:r,processVisitedMapPerApp:{},memoryMetrics:i,appsStats:t,includeFrameUuid:e};if(this.trackAppCountOnly){const{cachedAppsCount:e,activeAppsCount:i}=this.processCachedAppCount();return{...t,cachedAppsCount:e,activeAppsCount:i}}this.processMemoryInformation({...a,computeActiveApps:!0}),this.processMemoryInformation({...a,computeActiveApps:!1});for(const e of Object.keys(s)){const i=s[e];if(i){for(const t of Object.keys(r)){const{appIds:s}=r[t];if(s.find((t=>t===e))&&s.length>1){i.isSharingProcess=!0;break}}t.appsPlatformStats.push(i)}}return t}addPerAppMetricsInfo(e,t,i){e.totalAppCommitSizeKB+=t,e.totalAppWorkingSetSizeKB+=i}addAppStatsInfo(e,t,i,r){e?(r.activeWorkingSetSizeKB+=t,r.activeCommitSizeKB+=i):(r.cachedWorkingSetSizeKB+=t,r.cachedCommitSizeKB+=i)}processCachedAppCount(){let e=0,t=0;const i=Object.keys(this.uuidToAppIdMap);for(const r of i){const i=this.uuidToAppIdMap[r];!i?.managedByCache||this.isActiveApp(r)?e+=1:t+=1}return{cachedAppsCount:t,activeAppsCount:e}}processMemoryInformation(e){const{windows:t,computeActiveApps:i,appsStats:r,memoryMetrics:s,processVisitedMap:a,appsVisited:o,includeFrameUuid:n}=e;for(const e of t)for(const t of e.frames){if(!t.platformFrameUuid)continue;const c=this.uuidToAppIdMap[t.platformFrameUuid],l=!c?.managedByCache||this.isActiveApp(t.platformFrameUuid),p=c?.isPrecachedApp;if(c&&c.appId&&!o[c.appId]&&(o[c.appId]={appId:c.appId,isSharingProcess:!1,totalAppCommitSizeKB:0,totalAppWorkingSetSizeKB:0}),l===!i)continue;const h={windowId:e.windowId,isCached:!l,isPrecachedApp:p,totalFrameWorkingSetSizeKB:0,totalFrameCommitSizeKB:0,maxCpuCycleTime:0,frameInfo:[],appId:c?.appId??"",platformFrameUuid:n?t.platformFrameUuid:void 0};this.computeSizeOfFrames({frames:[t],appsStats:r,memoryMetrics:s,perAppFrameData:h,isActiveApp:l,processVisitedMap:a,appsVisited:o,treeLevel:0},h.appId,h.platformFrameUuid),r.appsPlatformFrameStats.push(h)}}}var f=i(875004),y=i(236880);class v{constructor(e,t,i){this.leakDetectorService=t,this.fallbackHost=i,this.logger=e.newLogger("StyleMetricsService","core-services-telemetry"),this.currentStyles=this.getCurrentStyles()}getTelemetry(){const e=this.getCurrentStyles(),t=e-this.currentStyles;return t>0&&this.logger.warn(`Style count increased by ${t} since last heartbeat. New Style count: ${e}`),this.currentStyles=e,{Style_Count:e,Style_Delta:t}}getPrimaryWindow(){const e=this.leakDetectorService?.getReachableObjects(y.J.UnwrappedWindow);return e&&0!==e.size?Array.from(this.leakDetectorService?.getReachableObjects(y.J.UnwrappedWindow)).find((e=>e.windowLeakInfo?.windowLeakInfoViewportContext===f.k.primary)):this.fallbackHost}getCurrentStyles(){const e=this.getPrimaryWindow();return e?Array.from(e.document.styleSheets).filter((e=>!e.href)).flatMap((e=>Array.from(e.cssRules))).length:0}}var _=i(328143),M=i(886916);const b={[c.VeryActive]:0,[c.Active]:1,[c.Inactive]:2,[c.LongInactive]:3,[c.Initializing]:4,[c.Unrecoverable]:5,Unknown:6},C=Object.entries(b).reduce(((e,[t,i])=>(e[i]="Unknown"===t?void 0:t,e)),{}),P=e=>{const t=e.map((e=>b[e??"Unknown"])).sort(((e,t)=>e-t));return C[t[0]]},w=[l.Lg.LongInactive],k=e=>w.includes(e),A=e=>e.map((e=>e.processId)).concat(...e.map((e=>A(e.frames)))).filter((e=>void 0!==e));class T{constructor(e){this.context=e,this.isRunning=!1,this.timeouts={},this.lastBeatTimes={},this.intervals={},this.granularSystemMetrics=[],this.granularTotalMetrics=[],this.granularNativeMetrics=[],this.granularWorkerMetrics=[],this.packedCallingData=new Map,this.peakWorkingSetByProcess=new Map,this.peakUsedJSHeapSize=0,this.granularJSHeapMetrics=[],this.getHeartbeatStandardInterval=()=>this._configuration?.intervalInSeconds??Number.MAX_SAFE_INTEGER,this.getHeartbeatInterval=e=>{const t=this.getHeartbeatStandardInterval(),i=this._configuration?.maxIntervalInSeconds??t,r=Math.max(1,this._configuration?.delayFactor??1),s=this.context.clientState?.getState();return s&&k(s)?Math.min(i,Math.max(e,t)*r):t},this.getMemorySubInterval=()=>this._configuration?.memoryMetricsCollection?.collectionIntervalInSeconds??Number.MAX_SAFE_INTEGER,this.logger=e.loggerFactory.newLogger("Heartbeat","core-services-telemetry");const{enableAppCountTracking:t}=e.coreSettings.get(p.w.Extensibility);this.platformAppsManagementService=new S(e.loggerFactory,e.hostCommunicationService,!!t),this.styleMetricsService=new v(e.loggerFactory,e.leakDetectorService,e.windowProvider)}static getInstance(){return T.instance}get configuration(){return this._configuration}getPlatformAppsService(){return this.platformAppsManagementService}async start(){T.instance||(T.instance=this,this.logger.debug("Starting the monitor..."),this.initializedTime=Date.now(),this.subscribeToCoreSettings(),this.subscribeToClientState(),await this.registerScenarios())}isHeartbeatMonitorRunning(){return this.isRunning}async getMemoryData(e){if(this._configuration?.memoryMetricsCollection?.enabled){if(e)return this.getAverageMemoryMetrics(!1);if(this.isRunning){const{jsHeapMetrics:e,nativeMemoryMetrics:t,hasExtraRenderer:i}=await this.getMemoryAndJSHeapData();return{...e&&(0,d.Cd)(e,this.peakUsedJSHeapSize),...t&&{Perf_TotalPhysicalMemory:t.system.totalPhysicalMemoryKB,Perf_AvailablePhysicalMemory:t.system.availablePhysicalMemoryKB,Perf_TotalSwapMemory:t.system.totalSwapMemoryKB,Perf_AvailableSwapMemory:t.system.availableSwapMemoryKB,Perf_MemoryLoad:t.system.memoryLoad},...t&&(0,d.Ac)(t.processes,this.peakWorkingSetByProcess,this.mainRendererProcessId),...t&&(0,d.EE)(t.workers),hasExtraRenderer:i}}}return{}}async collectData(){const e=this.getActions().map((async e=>{try{let t;const i=await Promise.race([e(),new Promise((i=>{t=this.context.windowProvider.setTimeout((()=>{this.logger.errorToTelemetry?.(`call to function '${e}'/'${e.name}' timeouts in heartbeat monitor.`,"fundamentals_performance_heartbeat_monitor"),i({})}),1e4)}))]);return this.context.windowProvider.clearTimeout(t),i}catch{return this.logger.errorToTelemetry?.(`call to function '${e}'/'${e.name}' failed in heartbeat monitor.`,"fundamentals_performance_heartbeat_monitor"),{}}}));return Object.assign.apply(Object,await Promise.all(e))}collectCallingData(e,t){const{enableCallingCDLTrackingNS:i}=this.context.coreSettings.get(p.w.Calling)||{};this.packedCallingData.set(e,(this.packedCallingData.get(e)??[]).concat(i?{...t,cdlData:this.context.graphqlOpsCountService?.getLatestDataAndClear()}:t))}setLoopVersion(e){e&&(!this.loopVersion||e>this.loopVersion)&&(this.loopVersion=e)}getActions(){const e=[];e.push(this.getLoopVersion.bind(this)),this._configuration?.memoryMetricsCollection?.enabled&&e.push(this.getAverageMemoryMetrics.bind(this,!0)),this._configuration?.simpleCollabMetricsCollection?.enabled&&e.push(this.getIsSimpleCollabEnabled.bind(this)),this._configuration?.elapsedTimeTracking?.enabled&&e.push(this.getElapsedTime.bind(this)),this._configuration?.screenInfoCollection?.enabled&&e.push(n.bind(this,this.context.windowProvider)),this._configuration?.inpMetricsCollection?.enabled&&e.push(this.getInpMetrics.bind(this)),this._configuration?.ariMetricsCollection?.enabled&&e.push(this.getAriMetrics.bind(this)),this._configuration?.dataClientMetricsCollection?.enabled&&e.push(this.getDataClientMetrics.bind(this)),this._configuration?.windowMetricsCollection?.enabled&&e.push(this.getWindowMetrics.bind(this)),this._configuration?.clientStateMetricsCollection?.enabled&&e.push(this.getClientStateMetrics.bind(this)),this._configuration?.OLDMetricsCollection?.enabled&&e.push(this.getObjectLeakDetectorMetrics.bind(this));const{enableCallingDataCollectionInHeartbeatConfig:t}=this.context.coreSettings.get(p.w.Calling)||{};return t&&this._configuration?.callingDataCollection?.enabled&&e.push(this.getCallingData.bind(this)),this._configuration?.graphqlStoreMetricsCollection?.enabled&&e.push(this.getGraphQLStoreMetrics.bind(this)),this._configuration?.platformAppMetricsCollection?.enabled&&e.push(this.getPlatformAppsMetrics.bind(this)),this._configuration?.styleMetricsCollection?.enabled&&e.push(this.getStyleMetrics.bind(this)),this._configuration?.vdiMetricsCollection?.enabled&&e.push(this.getVdiMetrics.bind(this)),this._configuration?.slimcoreVersionCollection?.enabled&&e.push(this.getSlimcoreVersionMetric.bind(this)),e}stopHeartbeat(){this.isRunning&&this.logger.debug("stopping heartbeat monitor"),Object.keys(this.timeouts).forEach((e=>{this.context.windowProvider.clearTimeout(this.timeouts[e])})),this.timeouts={},this.isRunning=!1}subscribeToCoreSettings(){const e=this.context.coreSettings.getObservable(p.w.Telemetry,["enableHeartbeatMonitor","heartbeatConfiguration"]),t=this.context.coreSettings.getObservable(p.w.Extensibility,["enableAppCountTracking"]);let i=this.context.coreSettings.get(p.w.Telemetry).heartbeatConfiguration;e.subscribe((e=>{const{enableHeartbeatMonitor:t,heartbeatConfiguration:r}=e;r?(this._configuration=r,this.logger.debug("Configuration loaded...",this._configuration)):t&&this.logger.errorToTelemetry?.("'heartbeatConfiguration' not found.","fundamentals_performance_heartbeat_monitor"),t?(this.startHeartbeat(),this._configuration?.memoryMetricsCollection?.enabled||(this.context.windowProvider.clearTimeout(this.timeouts.memory),this.timeouts.memory=void 0)):(this._configuration=void 0,this.stopHeartbeat()),this._configuration?.intervalInSeconds&&i?.intervalInSeconds!==this._configuration?.intervalInSeconds&&this.overrideNextBeat(),i=this._configuration})),t.subscribe((e=>{const{enableAppCountTracking:t}=e;this.platformAppsManagementService.updateAppCountTrackingFlag(!!t)}))}startHeartbeat(){!this.isRunning&&this.logger.debug("starting heartbeat monitor"),this.scheduleNextTimeout("heartbeat",this.isRunning?this.getHeartbeatInterval(0):Math.min(30,this.getHeartbeatInterval(0)),this.beat.bind(this),this.getHeartbeatInterval,!1),this.scheduleNextTimeout("memory",this.isRunning?this.getMemorySubInterval():Math.min(25,this.getMemorySubInterval()),this.collectGranularMemoryAndJSHeapData.bind(this),this.getMemorySubInterval,!1),this.isRunning=!0}overrideNextBeat(){if(!this.isRunning)return;const e=this.getHeartbeatInterval(0)*h.f2.second,t=Date.now(),i=((this.lastBeatTimes.heartbeat??this.initializedTime??t)+e-t)/h.f2.second;this.scheduleNextTimeout("heartbeat",i>0?i:0,this.beat.bind(this),this.getHeartbeatInterval,!0)}subscribeToClientState(){const{clientState:e}=this.context;if(!e)return void this.context.windowProvider.setTimeout((()=>this.subscribeToClientState()),100);this.logger.log("Client state is available, preparing subscription");const t=e.observe();let i=e.getState();t.subscribe({next:e=>{k(i)&&!k(e)&&this.overrideNextBeat(),i=e}})}scheduleNextTimeout(e,t=Number.MAX_SAFE_INTEGER,i,r,s){const a=t*h.f2.second;0<=a&&a<2147483647&&(s&&this.timeouts[e]&&(this.context.windowProvider.clearTimeout(this.timeouts[e]),this.timeouts[e]=void 0),this.timeouts[e]||(this.intervals[e]=t,this.timeouts[e]=this.context.windowProvider.setTimeout((async()=>{this.timeouts[e]=void 0;try{await i()}catch{this.logger.errorToTelemetry?.(`call to function '${i}' failed in heartbeat monitor.`,"fundamentals_performance_heartbeat_monitor")}finally{this.lastBeatTimes[e]=Date.now(),this.scheduleNextTimeout(e,r(t),i,r,!1)}}),a)))}async beat(){const e=await this.collectData();(0,m.ni)(e)}getElapsedTime(){const e=Date.now(),t=this.initializedTime||e;return{elapsed:Math.floor((e-t)/h.f2.second)}}async getIsSimpleCollabEnabled(){const e={Perf_SimpleCollab_ViewType:void 0};return e.Perf_SimpleCollab_ViewType=await this.fetchSimpleCollabViewType(),e}async fetchSimpleCollabViewType(){const{enableSimpleCollabApp:e,enableSimpleCollabAppSplitView:t}=this.context.coreSettings.get(p.w.SimpleCollab);let i;if(e){let r={};try{const{data:e}=await this.context.client.query({query:M.W,fetchPolicy:"cache-only"}),t=e?.userPreferencesForSimpleCollab;t&&"simpleCollabUserSettings"in t&&t.simpleCollabUserSettings&&(r=t.simpleCollabUserSettings)}catch{r={}}finally{i=(0,_.Dt)(!!e,!!t,r)}}return i}getLoopVersion(){return{AppInfo_Loop_Version:this.loopVersion}}getAverageMemoryMetrics(e){const t={};if(this.granularSystemMetrics.length){const e=(0,g.meanBy)(this.granularSystemMetrics,(e=>e.availablePhysicalMemoryKB));t.Perf_AvailablePhysicalMemory=isNaN(e)?void 0:e;const i=(0,g.meanBy)(this.granularSystemMetrics,(e=>e.totalPhysicalMemoryKB));t.Perf_TotalPhysicalMemory=isNaN(i)?void 0:i;const r=(0,g.meanBy)(this.granularSystemMetrics,(e=>e.availableSwapMemoryKB));t.Perf_AvailableSwapMemory=isNaN(r)?void 0:r;const s=(0,g.meanBy)(this.granularSystemMetrics,(e=>e.totalSwapMemoryKB));t.Perf_TotalSwapMemory=isNaN(s)?void 0:s;const a=(0,g.meanBy)(this.granularSystemMetrics,(e=>e.memoryLoad));t.Perf_MemoryLoad=isNaN(a)?void 0:a}const i={};if(this.granularTotalMetrics.length){i.Perf_MultiCloud_MaxActivityState=P(this.granularTotalMetrics.map((e=>e.clientState)));const e=(0,g.meanBy)(this.granularTotalMetrics,(e=>e.workingSetSizeKB));i.Perf_MultiCloudTotal_WorkingSet=isNaN(e)?void 0:Math.round(e);const t=(0,g.meanBy)(this.granularTotalMetrics,(e=>e.privateWorkingSetSizeKB));i.Perf_MultiCloudTotal_PrivateWorkingSet=isNaN(t)?void 0:Math.round(t);const r=(0,g.meanBy)(this.granularTotalMetrics,(e=>e.commitSizeKB));i.Perf_MultiCloudTotal_CommitSize=isNaN(r)?void 0:Math.round(r);const s=this.granularTotalMetrics.map((e=>e.processCount)).filter((e=>void 0!==e));i.Perf_MultiCloudTotal_NumberOfProcesses=s.length>0?Math.max(...s):0}const r=[];if(this.granularNativeMetrics.length){const e=new Map(this.peakWorkingSetByProcess.entries());this.peakWorkingSetByProcess.clear(),this.granularNativeMetrics.reduce(((e,t)=>{for(const i of t){const{processId:t}=i;e.set(t,(e.get(t)??[]).concat(i))}return e}),new Map).forEach(((t,i)=>{this.peakWorkingSetByProcess.set(i,e.get(i)??0);const s=(0,g.meanBy)(t,(e=>e.workingSetSizeKB)),a=(0,g.meanBy)(t,(e=>e.privateWorkingSetSizeKB)),o=(0,g.meanBy)(t,(e=>e.commitSizeKB)),n={processId:i,type:t[0].type,utilitySubType:t[0].utilitySubType,cpuCycleTime:t[0].cpuCycleTime,workingSetSizeKB:isNaN(s)?void 0:Math.round(s),privateWorkingSetSizeKB:isNaN(a)?void 0:Math.round(a),commitSizeKB:isNaN(o)?void 0:Math.round(o),cloudActivityState:P(t.map((e=>e.cloudActivityState))),isFromMyCloud:t[0].isFromMyCloud};r.push(n)}))}const s=[];this.granularWorkerMetrics.length&&this.granularWorkerMetrics.reduce(((e,t)=>{for(const i of t){const{targetSessionId:t}=i;e.set(t,(e.get(t)??[]).concat(i))}return e}),new Map).forEach(((e,t)=>{const i=(0,g.meanBy)(e,(e=>e.totalSizeKB)),r=(0,g.meanBy)(e,(e=>e.usedSizeKB)),a={targetSessionId:t,type:e[0].type,subType:e[0].subType,url:e[0].url,totalSizeKB:isNaN(i)?void 0:Math.round(i),usedSizeKB:isNaN(r)?void 0:Math.round(r)};s.push(a)}));const a=P(r.map((e=>e.cloudActivityState))),o=r.filter((e=>!1!==e.isFromMyCloud)),n=(0,d.Ac)(o,this.peakWorkingSetByProcess,this.mainRendererProcessId),c=(0,d.No)(r),l=(0,d.EE)(s);let p={};if(this.granularJSHeapMetrics.length){const e={jsHeapSizeLimit:Math.round((0,g.meanBy)(this.granularJSHeapMetrics,(e=>e.jsHeapSizeLimit||0))),totalJSHeapSize:Math.round((0,g.meanBy)(this.granularJSHeapMetrics,(e=>e.totalJSHeapSize||0))),usedJSHeapSize:Math.round((0,g.meanBy)(this.granularJSHeapMetrics,(e=>e.usedJSHeapSize||0)))};p=(0,d.Cd)(e,this.peakUsedJSHeapSize)}e&&(this.granularSystemMetrics=[],this.granularTotalMetrics=[],this.granularNativeMetrics=[],this.granularWorkerMetrics=[],this.granularJSHeapMetrics=[]);const h={...t,...n,...c,...l,...p,Perf_MultiCloud_MaxActivityState:a,hasExtraRenderer:this.hasExtraRenderer,...i};return this.hasExtraRenderer=void 0,h}getInpMetrics(){const e={Perf_Inp:""};if(this.context.interactionToNextPaintService){const t=this.context.interactionToNextPaintService.getTelemetry();e.Perf_Inp=t}return e}getAriMetrics(){const e={Perf_Ari:""};if(this.context.appResponsivenessService){const t=this.context.appResponsivenessService.getTelemetry();e.Perf_Ari=t}return e}getDataClientMetrics(){const e={Perf_ApolloCacheStats:void 0};if(this.context.dataClientTrackingService){const t=this.context.dataClientTrackingService.getTelemetry();e.Perf_ApolloCacheStats=t}return e}getWindowMetrics(){const e={Perf_WindowStats:void 0};if(this.context.windowTrackerService){const t=this.context.windowTrackerService.getTelemetry();e.Perf_WindowStats=t}return e}getObjectLeakDetectorMetrics(){const e={};if(this.context.leakDetectorService){const t=this.context.leakDetectorService.getTelemetry();if(t){const{counts:i,leakStats:r,leaks:s,countsRecord:a,hasWindowLeak:o,hasApolloLeak:n}=t;e.Perf_OLDStats=i,e.Perf_LeakStats=r,e.Perf_Leaks=s,e.Perf_LeaksRecord=a,e.Perf_Leaks_HasWindowLeak=o,e.Perf_Leaks_HasApolloLeak=n}}return e}getClientStateMetrics(){const e={Perf_IsUserInCall:void 0};if(this.context.clientState){const t=this.context.clientState.getState()===l.Lg.VeryActive;e.Perf_IsUserInCall=t}return e}getCallingData(){const e={Perf_Calling_Data:void 0,Perf_HasCallingData:void 0,Perf_IsScreenSharing:void 0,Perf_IsReceivingScreenSharing:void 0,Perf_IsSendingContentSharing:void 0,Perf_IsReceivingContentSharing:void 0,Perf_IsVideoOn:void 0,Perf_MeetingCode:void 0,Perf_ThreadId:void 0},t=[];for(const[,e]of this.packedCallingData)t.push(...e);return e.Perf_HasCallingData=t.length>0,e.Perf_HasCallingData&&(e.Perf_Calling_Data=t.map((e=>JSON.stringify(e))),e.Perf_IsScreenSharing=t.some((e=>e?.callDataBag?.isScreenSharing)),e.Perf_IsReceivingScreenSharing=t.some((e=>e?.callDataBag?.isReceivingScreenSharing)),e.Perf_IsSendingContentSharing=t.some((e=>e?.callDataBag?.isSendingContentSharing)),e.Perf_IsReceivingContentSharing=t.some((e=>e?.callDataBag?.isReceivingContentSharing)),e.Perf_IsVideoOn=t.some((e=>e?.callDataBag?.isVideoOn)),e.Perf_MeetingCode=t.find((e=>""!==e?.callDataBag?.meetingCode))?.callDataBag?.meetingCode,e.Perf_ThreadId=t.find((e=>""!==e?.callDataBag?.threadId))?.callDataBag?.threadId),this.packedCallingData.clear(),e}getGraphQLStoreMetrics(){const e={};if(this.context.graphqlStoreStatsReporterService){e.Perf_GraphQLStoreStats=this.context.graphqlStoreStatsReporterService.getTelemetry();const t=this.context.graphqlStoreStatsReporterService.getFieldsTelemetry();t.hasData&&(e.Perf_GraphQLFieldsStats=t)}return e}async getPlatformAppsMetrics(){let e={};const t=await this.platformAppsManagementService.getTelemetry();return t&&(e={Perf_PlatformApps_Active_WorkingSet:t.activeWorkingSetSizeKB,Perf_PlatformApps_Cached_WorkingSet:t.cachedWorkingSetSizeKB,Perf_PlatformApps_Active_Commit_Size:t.activeCommitSizeKB,Perf_PlatformApps_Cached_Commit_Size:t.cachedCommitSizeKB,Perf_PlatformApps_Count_CachedApps:t.cachedAppsCount,Perf_PlatformApps_Count_ActiveApps:t.activeAppsCount,Perf_PlatformApps_Frame_Stats:t.appsPlatformFrameStats,Perf_PlatformApps_Stats:t.appsPlatformStats}),e}getStyleMetrics(){return this.styleMetricsService.getTelemetry()}getVdiMetrics(){return{vdiMode:this.context.platformService?.config.vdi?.mode??""}}getSlimcoreVersionMetric(){if(void 0===this.slimcoreVersion)try{this.slimcoreVersion=this.context.windowProvider.SlimCore?.getVersion?.().toString()||""}catch{this.slimcoreVersion=""}return{slimCoreVersion:this.slimcoreVersion}}async getMemoryAndJSHeapData(){let e,t,i;if(this.context.hostCommunicationService){e=await u(this.context.hostCommunicationService,this.logger,this._configuration?.workerMetricsCollection?.enabled||!1);const t=[];let r=0;for(const i of e.processes){const{type:e,isMainRenderer:s,processId:a}=i;"renderer"===e.toLowerCase()&&(s&&(r=a),t.push(i))}this.mainRendererProcessId=this.mainRendererProcessId&&t.find((e=>e.processId===this.mainRendererProcessId))?this.mainRendererProcessId:r||t.sort(((e,t)=>(t.workingSetSizeKB??0)-(e.workingSetSizeKB??0)))[0]?.processId;const s=e.windows.flatMap((e=>[e.processId,...A(e.frames)]));i=t.length>0&&!t.every((e=>e.isMainRenderer||s.includes(e.processId)))}else this.logger.errorToTelemetry?.("Invalid hostCommunicationService, cannot get native metrics from Desktop","fundamentals_performance_heartbeat_monitor");return this.context.windowProvider?t=function(e,t){let i,r,s;try{const t=e?.performance,a=t?.memory;a&&(i=(0,d.vr)(a.jsHeapSizeLimit),r=(0,d.vr)(a.totalJSHeapSize),s=(0,d.vr)(a.usedJSHeapSize))}catch{t.errorToTelemetry?.("get-js-performance-info, getJsPerformanceInfo: Failed to process JS metrics.","fundamentals_performance_get_js_performance_info")}return{jsHeapSizeLimit:i,totalJSHeapSize:r,usedJSHeapSize:s}}(this.context.windowProvider,this.logger):this.logger.errorToTelemetry?.("Invalid windowProvider, cannot get js metrics from window","fundamentals_performance_heartbeat_monitor"),{nativeMemoryMetrics:e,jsHeapMetrics:t,hasExtraRenderer:i}}async collectGranularMemoryAndJSHeapData(){const{nativeMemoryMetrics:e,jsHeapMetrics:t,hasExtraRenderer:i}=await this.getMemoryAndJSHeapData(),r=this.intervals.heartbeat??this.getHeartbeatStandardInterval(),s=Math.max(Math.round(r/this.getMemorySubInterval()),1)||1;if(e){this.granularSystemMetrics=this.granularSystemMetrics.concat([e.system]).slice(-s),e.total&&(this.granularTotalMetrics=this.granularTotalMetrics.concat([e.total]).slice(-s)),this.granularNativeMetrics=this.granularNativeMetrics.concat([e.processes]).slice(-s),this.granularWorkerMetrics=this.granularWorkerMetrics.concat([e.workers]).slice(-s);for(const t of e.processes){const{processId:e}=t,i=this.peakWorkingSetByProcess.get(e);this.peakWorkingSetByProcess.set(e,Math.max(i||0,t.workingSetSizeKB||0))}}t&&(this.peakUsedJSHeapSize=Math.max(this.peakUsedJSHeapSize,t.usedJSHeapSize||0),this.granularJSHeapMetrics=this.granularJSHeapMetrics.concat(t).slice(-s)),this.hasExtraRenderer||(this.hasExtraRenderer=i)}async registerScenarios(){if(this.context.hostCommunicationService){const e=await this.context.hostCommunicationService.loadModule("heartbeat");if(e?.registerForScenarioStart)try{e.registerForScenarioStart((e=>{}))}catch{this.logger.error("Failed to register for listening to host scenarios starting")}if(e?.registerForScenarioStop)try{e.registerForScenarioStop((e=>{}))}catch{this.logger.error("Failed to register for listening to host scenarios stopping")}}}}T.instance=void 0},880386:(e,t,i)=>{i.d(t,{EE:()=>a,Ac:()=>o,No:()=>n,Cd:()=>c,vr:()=>l,VQ:()=>p});var r=i(480354);const s=1024;function a(e){const t={},i=[...e];return f(t,"TelemetryWorker",M(i,"TelemetryWorker")),f(t,"CDLWorker",M(i,"CDLWorker")),f(t,"ServiceWorker",M(i,"ServiceWorker")),f(t,"UnknownWorker",i),t.Perf_Unknown_Workers=i,t.Perf_TotalWorker_UsedSize=d(e),t.Perf_TotalWorker_TotalSize=m(e),t.Perf_Total_NumberOfWorkers=e.length,t}function o(e,t,i){const r={},s=[...e];y(r,"GPU",_(s,["gpu-process","Gpu"]),t),y(r,"NativeShell",_(s,["nativeShell","NativeShell"]),t),y(r,"CrashpadHandler",_(s,"crashpad-handler"),t),y(r,"Browser",_(s,["browser","Browser"]),t);const a=_(s,["renderer","Renderer"]);r.Perf_Renderer_Count_Processes=a.length,y(r,"Renderer",a,t),y(r,"SlimCore",_(s,["NativeModuleProcess_SlimCore"]),t);const o=_(s,["utility","Utility"]);if(y(r,"Utility",o,t),r.Perf_Utility_Process=[...o],y(r,"Total",e),r.Perf_Unknown_Process=s,r.Perf_Unknown_NumberOfProcesses=s.length,r.Perf_Unknown_WorkingSet=u(s),r.Perf_Unknown_PrivateWorkingSet=g(s),r.Perf_Unknown_CommitSize=S(s),i){const s=e.find((e=>e.processId===i));s&&(r.Perf_MainRenderer_WorkingSet=u([s]),r.Perf_MainRenderer_PrivateWorkingSet=g([s]),r.Perf_MainRenderer_CommitSize=S([s]),r.Perf_MainRenderer_PeakWorkingSet=t?.get(i))}return r}function n(e){const t={};return y(t,"MultiCloudTotal",e),t}function c(e,t){const i={},{totalJSHeapSize:r,jsHeapSizeLimit:s,usedJSHeapSize:a}=e;return r&&(i.Perf_JSHeap_TotalSize=r),s&&(i.Perf_JSHeap_LimitSize=s),a&&(i.Perf_JSHeap_UsedSize=a),t&&(i.Perf_Peak_UsedJSHeapSize=t),i}function l(e){return"number"!=typeof e||isNaN(e)?void 0:Math.round(e/s)}const p=l;function h(e,t){const i=(0,r.sumBy)(e,(e=>e[t]??NaN));return 0===e.length||isNaN(i)?void 0:i}function m(e){return h(e,"totalSizeKB")}function d(e){return h(e,"usedSizeKB")}function u(e){return h(e,"workingSetSizeKB")}function g(e){return h(e,"privateWorkingSetSizeKB")}function S(e){return h(e,"commitSizeKB")}function f(e,t,i){e[`Perf_${t}_UsedSize`]=d(i),e[`Perf_${t}_TotalSize`]=m(i),e[`Perf_Total_NumberOf${t}s`]=i.length}function y(e,t,i,r){if(e[`Perf_${t}_WorkingSet`]=u(i),e[`Perf_${t}_PrivateWorkingSet`]=g(i),e[`Perf_${t}_CommitSize`]=S(i),"Total"===t||"MultiCloudTotal"===t)e[`Perf_${t}_NumberOfProcesses`]=i.length;else{if(e[`Perf_${t}_Count_Processes`]=i.length,!r||!i.length)return;const s=Math.max(...i.map((e=>r.get(e.processId)||0)));s&&(e[`Perf_${t}_PeakWorkingSet`]=s)}}function v(e,t){let i;const r=[];for(;i=e.findIndex(t),-1!==i;)r.push(e.splice(i,1)[0]);return r}function _(e,t){const i="string"==typeof t?[t]:t;return v(e,(e=>i.includes(e.type)))}function M(e,t){return v(e,(e=>e.subType.includes(t)))}}}]);
//# sourceMappingURL=https://local.teams.office.com/sourcemaps/hashed-assets/823172-9302e077010121f4.js.map